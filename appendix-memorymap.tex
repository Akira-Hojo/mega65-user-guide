\chapter{System Memory Map}
\label{cha:memory-map}
\section{Introduction}

The MEGA65 computer has a large 28-bit address space, which allows it
to address upto 256MiB of memory and memory-mapped devices. 
This memory map has several different views, depending on which mode
the computer is operating in. Broadly, there are five main modes: 
(1) Hypervisor mode; (2) C64 compatibility mode; (3) C65 compatibility mode; (4) UltiMAX
compatibility mode; and (5) MEGA65 mode, or one of the other modes,
where the programmer has made use of MEGA65 enhanced features. 

It is important to understand that, unlike the C128, the C65 and
MEGA65 allow access to all enhanced features from C64 mode, if the
programmer wishes to do so.  This means that while we frequently talk
about ``C64 Mode,'' ``C65 Mode'' and ``MEGA65 Mode,'' these are simply
terms of convenience for the MEGA65 with its memory map (and sometimes
other features) configured to provide an environment that matches
the appropriate mode.  The heart of this is the MEGA65's flexibly
memory map.

In this appendix, we will begin by describing the MEGA65's native
memory map, that is, where all of the memory, IO devices and other
features appear in the 28-bit address space. We will then explain how
C64 and C65 compatible memory maps are accessed from this 28-bit
address space.

\section{MEGA65 Native Memory Map}

\setlength{\tabcolsep}{3pt}
\begin{longtable}{|L{1.5cm}|L{2cm}|L{1.1cm}|p{5cm}|}
\hline
{\bf{HEX}} & {\bf{DEC}} & {\bf{Size}} & {\bf{Contents}} \\
\hline
\endfirsthead
\multicolumn{3}{l@{}}{\ldots continued}\\
\hline
{\bf{HEX}} & {\bf{DEC}} & {\bf{Size}} & {\bf{Contents}} \\
\endhead
\multicolumn{3}{l@{}}{continued \ldots}\\
\endfoot
\hline
\small 0000000 & \small 0 & 1 & \multicolumn{1}{p{5cm}|}{CPU IO Port Data
  Direction Register}\\
\hline
\small 0000001 & \small 1 & 1 & \multicolumn{1}{p{5cm}|}{CPU IO Port Data}\\
\hline
\small 0000002 -- 005FFFF & \small 2 -- 384 KiB & 384 KiB &
\multicolumn{1}{p{5cm}|}{Fast chip RAM (40MHz)}\\
\hline
\small 0060000 -- 0FFFFFF & \small 384 KiB -- 16 MiB  & 15.6 MiB &
\multicolumn{1}{p{5cm}|}{Reserved for future chip RAM expansion}\\
\hline
\small 1000000 -- 3FFFFFF & \small 16 MiB -- 64 MiB & 48 MiB &
\multicolumn{1}{p{5cm}|}{Reserved}\\
\hline
\small 4000000 -- 7FFFFFF & \small 64 MiB -- 128 MiB & 64 MiB &
\multicolumn{1}{p{5cm}|}{Cartridge port and other devices on the slow bus
  (1 -- 10 MHz)}\\
\hline
\small 8000000 -- 87FFFFF & \small 128 MiB -- 135 MiB & 8 MiB &
\multicolumn{1}{p{5cm}|}{8MB ATTIC RAM (selected models only)}\\
\hline
\small 8800000 -- 8FFFFFF & \small 135 MiB -- 144 MiB & 8 MiB &
\multicolumn{1}{p{5cm}|}{8MB CELLAR RAM (selected models only)}\\
\hline
\small 9000000 -- EFFFFFF & \small 144 MiB -- 240 MiB & 96 MiB &
\multicolumn{1}{p{5cm}|}{Reserved for future expansion RAM}\\
\hline
\small F000000 -- FF7DFFF & \small 240 MiB -- 255.49 MiB & 15.49 MiB &
\multicolumn{1}{p{5cm}|}{Reserved for future IO expansion}\\
\hline
\small FF7E000 -- FF7EFFF & \small 255.49 MiB -- 255.49 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{VIC-IV Character ROM (write only)}\\
\hline
\small FF80000 -- FF87FFF & \small 255.5 MiB -- 255.53 MiB & 32 KiB &
\multicolumn{1}{p{5cm}|}{VIC-IV Colour RAM}\\
\hline
\small FF88000 -- FF8FFFF & \small 255.53 MiB -- 255.57 MiB & 32 KiB &
\multicolumn{1}{p{5cm}|}{Additional VIC-IV Colour RAM (selected models only)}\\
\hline
\small FF90000 -- FFCAFFF & \small 255.53 MiB -- 255.80 MiB & 216 KiB &
\multicolumn{1}{p{5cm}|}{Reserved}\\
\hline
\small FFCB000 -- FFCBFFF & \small 255.80 MiB -- 255.80 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{Emulated C1541 RAM}\\
\hline
\small FFCC000 -- FFCFFFF & \small 255.80 MiB -- 255.81 MiB & 16 KiB &
\multicolumn{1}{p{5cm}|}{Emulated C1541 ROM}\\
\hline
\small FFD0000 -- FFD0FFF & \small 255.81 MiB -- 255.81 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{C64 \$Dxxx IO Personality}\\

\hline
\small FFD1000 -- FFD1FFF & \small 255.81 MiB -- 255.82 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{C65 \$Dxxx IO Personality}\\

\hline
\small FFD2000 -- FFD2FFF & \small 255.82 MiB -- 255.82 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{MEGA65 \$Dxxx IO Personality A}\\

\hline
\small FFD3000 -- FFD3FFF & \small 255.82 MiB -- 255.82 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{MEGA65 \$Dxxx IO Personality B}\\
\hline
\small FFD4000 -- FFD5FFF & \small 255.82 MiB -- 255.83 MiB & 8 KiB &
\multicolumn{1}{p{5cm}|}{Reserved}\\
\hline
\small FFD6000 -- FFD67FF & \small 255.83 MiB -- 255.83 MiB & 2 KiB &
\multicolumn{1}{p{5cm}|}{Hypervisor scratch space}\\
\hline
\small FFD6000 -- FFD6BFF & \small 255.83 MiB -- 255.83 MiB & 3 KiB &
\multicolumn{1}{p{5cm}|}{Hypervisor scratch space}\\
\hline
\small FFD6C00 -- FFD6DFF & \small 255.83 MiB -- 255.83 MiB & 512 &
\multicolumn{1}{p{5cm}|}{F011 floppy controller sector buffer}\\
\hline
\small FFD6E00 -- FFD6FFF & \small 255.83 MiB -- 255.83 MiB & 512 &
\multicolumn{1}{p{5cm}|}{SD Card controller sector buffer}\\
\hline
\small FFD7000 -- FFD70FF & \small 255.83 MiB -- 255.83 MiB & 256 &
\multicolumn{1}{p{5cm}|}{MEGAphone r1 I2C peripherals}\\
\hline
\small FFD7100 -- FFD71FF & \small 255.83 MiB -- 255.83 MiB & 256 &
\multicolumn{1}{p{5cm}|}{MEGA65 r2 I2C peripherals}\\
\hline
\small FFD7200 -- FFD72FF & \small 255.83 MiB -- 255.83 MiB & 256 &
\multicolumn{1}{p{5cm}|}{MEGA65 HDMI I2C registers (only for models fitted
  with the ADV7511 HDMI driver chip)}\\
\hline
\small FFD7300 -- FFD7FFF & \small 255.83 MiB -- 255.84 MiB & 3.25 KiB &
\multicolumn{1}{p{5cm}|}{Reserved for future I2C peripherals}\\
\hline
\small FFD8000 -- FFDBFFF & \small 255.83 MiB -- 255.86 MiB & 16 KiB &
\multicolumn{1}{p{5cm}|}{Hypervisor ROM (only visible in Hypervisor Mode)}\\
\hline
\small FFDC000 -- FFDDFFF & \small 255.86 MiB -- 255.87 MiB & 8 KiB &
\multicolumn{1}{p{5cm}|}{Reserved for Hypervisor Mode ROM expansion}\\
\hline
\small FFDE000 -- FFDE7FF & \small 255.87 MiB -- 255.87 MiB & 2 KiB &
\multicolumn{1}{p{5cm}|}{Reserved for ethernet buffer expansion}\\
\hline
\small FFDE800 -- FFDEFFF & \small 255.87 MiB -- 255.87 MiB & 2 KiB &
\multicolumn{1}{p{5cm}|}{Ethernet frame read buffer (read only) and
  Ethernet frame write buffer (write only)}\\
\hline
\small FFDF000 -- FFDFFFF & \small 255.87 MiB -- 255.87 MiB & 4 KiB &
\multicolumn{1}{p{5cm}|}{Virtual FPGA registers (selected models only)}\\
\hline
\small FFE0000 -- FFFFFFF & \small 255.87 MiB -- 256 MiB & 128 KiB &
\multicolumn{1}{p{5cm}|}{Reserved}\\
\hline
\endlastfoot

\hline
\end{longtable}
