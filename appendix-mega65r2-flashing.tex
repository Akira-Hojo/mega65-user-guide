\chapter{Flashing the FPGAs and CPLDs in the MEGA65}

The MEGA65 is an open-source and open-hardware computer. This means you are free,
not only to write programs that run on the MEGA65 as a finished computer, but you can
use the re-programmable chips in the MEGA65 to turn it into all sorts of other things!

These re-programmable chips are called Field Programmable Gate Arrays (FPGAs) or
Complex Programmable Logic Devices (CPLDs), and can implement a wide variety of circuits.
They are normally programmed using a programming language like VHDL or Verilog.  These
are languages that are not commonly encountered by most people.  They are also quite
different in some ways to ``normal'' programming languages, and it can take a while to
understand how they work, but with some effort and perseverance, many people will be
able to do exiting things with them.

Be prepared to install many gigabytes of software on a Linux or Windows PC, before you will
be able to write programs for the FPGAs and CPLDs in the MEGA65.  Also, ``compiling'' complex
designs can take up to several hours, depending on the speed and memory capacity of your computer!
We recommend a computer with at least 8GB RAM, and preferably 16GB if you want to write
programs for FPGAs and CPLDs. If on the other hand all you want to do is load programs onto
your MEGA65's FPGAs and CPLDs that other people have written, then most computers running a recent
version of Windows or Linux should be able to cope.

\section{Warning}

Before we go any further, we do have to provide a warning about reprogramming the FPGAs and
CPLDs in the MEGA65.
Re-programming the MEGA65 FPGA can potentially cause
damage, or leave your MEGA65 in an unresponsive state from which it is very difficult to
recover, i.e., ``bricked''.  Therefore if you choose to open your MEGA65 and reprogram
any of the FPGAs it contains, it is no longer possible to guarantee its correct operation.
Therefore in this case we can not reasonably honour the warranty of the device as a computer.
You have been warned!

\section{Flashing the Artix 100T main FPGA with XILINX VIVADO}

If you choose to proceed, you will need a TE0790-03 JTAG programming module, a functioning
installation of Xilinx's Vivado software.  This can be done on either Windows or Linux, but
in both cases you will need to install any necessary USB drivers. It is also necessary to have
dip-switches 1 and 3 in the ON position and dip-switches 2 and 4 in the OFF position on the TE-0790.
With your MEGA65 disconnected from the power, the TE-0790 must be installed on the JB1 connector,
which is located between the floppy data cable and the audio jack.
The gold-plated hole of the TE-0790 must line up with the screw
hole below.  The mini-USB cable will then connect on the side towards the 3.5" floppy drive.
The following image shows the correct position: The TE0790 is surrounded by the yellow box,
and the dip-switches by the red box. Dip-switch 1 is the one nearest the floppy data cable.


\includegraphics[width=\linewidth]{images/jtag_detail_02.jpg}


Connect your non-8-bit computer to the FPGA programming device using a mini-USB cable. Open VIVADO, which can be downloaded from the internets.

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado01.png}
  \caption{Step 1: Open a project in VIVADO}
  \label{fig:vivado01}
\end{figure}

To access the Hardware Manager, open a project in VIVADO or create an empty one, if you do not have any projects yet.

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado02.png}
  \caption{Step 2: Open Hardware Manager}
  \label{fig:vivado02}
\end{figure}

In the left column, select "Open Hardware Manager" at the very bottom.

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado03.png}
  \caption{Step 3: Connect to FPGA}
  \label{fig:vivado03}
\end{figure}

Under "Hardware Manager", choose "Open Target", then "Auto Connect".

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado04.png}
  \caption{Step 4: Wait a moment}
  \label{fig:vivado04}
\end{figure}

Wait a moment, "Connecting to server..."  should automatically close without dropping an error to the console.

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado05.png}
  \caption{Step 5: Add Configuration Memory Device}
  \label{fig:vivado05}
\end{figure}

Under "Hardware Manager", choose "Add Configuration Memory Device", then "xc7a100t\_0".

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado06.png}
  \caption{Step 6: Select Memory Part}
  \label{fig:vivado06}
\end{figure}

In the newly opened dialogue, type "S25fl256s" (without quotes), then select "s25fl256sxxxxxxx0-spi-x1\_x2\_x4" (the upper one) and click "OK".

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado07.png}
  \caption{Step 7: Set programming options}
  \label{fig:vivado07}
\end{figure}

In the next dialogue, choose your local Configuration file, namely a bitstream with file suffix ".mcs". Leave all other parameters as they are (see \ref{fig:vivado07}).

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado08.png}
  \caption{Step 8: Programming in progress}
  \label{fig:vivado08}
\end{figure}

Patiently wait for the programming to finish. This can take several minutes as the Vivado software erases and then reprograms
the flash memory that is used to initialise the FPGA on power-up.

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado09.png}
  \caption{Step 9: Programming successful}
  \label{fig:vivado09}
\end{figure}

If your screen looks like \ref{fig:vivado09}, your new bistream has been successfully flashed into the Artix 100T FPGA!

\begin{figure}
  \includegraphics[width=\linewidth]{images/vivado09.png}
  \caption{Step 10: Reflashing the FPGA}
  \label{fig:vivado10}
\end{figure}

If you want to repeat the process, you might find the "Add Configuration Memory Device" option in step 5 greyed out. Instead, select "s25fl256sxxxxxxx0-spi-x1\_x2\_x4"  in the "Hardware" window, press right mouse button and select "Program Configuration Memory Device" to flash.

\section{Flashing the CPLD in the MEGA65's Keyboard with LATTICE DIAMOND}


If you choose to proceed, you will need a TE0790-03 JTAG programming module, a functioning
installation of Lattice Diamond Programmer software.  This can be done on either Windows or Linux, but
in both cases you will need to install any necessary USB drivers. It is also necessary to have
dip-switches 1 and 3 in the ON position and dip-switches 2 and 4 in the OFF position on the TE-0790.
With your MEGA65 disconnected from the power, the TE-0790 must be installed on the JB1 connector,
which is located between the floppy data cable and the audio jack.
The gold-plated hole of the TE-0790 must line up with the screw
hole below.  The mini-USB cable will then connect on the side towards the 3.5" floppy drive.
The following image shows the correct position: The TE0790 is surrounded by the yellow box,
and the dip-switches by the red box. Dip-switch 1 is the one nearest the floppy data cable.

One the PCB r2 MEGA65 Mainbord dip switch 1 (the one nearest to the user sitting in front of the machine
must be in the ON position, the other switches must be OFF. The keyboard will go into "Police Mode"
(blue and red blinking LEDs) when set correctly.


\includegraphics[width=\linewidth]{images/jtag_detail_05.jpg}


Connect your non-8-bit computer to the FPGA programming device using a mini-USB cable. Open DIAMOND PROGRAMMER, which can be downloaded from the internets.

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond01.png}
  \caption{Step 1: Open DIAMOND PROGRAMMER}
  \label{fig:diamond01}
\end{figure}

Select "Create a new project from a JTAG scan". If entry under "Cable:" is empty, click "Detect Cable".

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond02.png}
  \caption{Step 2: Create a new project}
  \label{fig:diamond02}
\end{figure}

If dialog "Programmer: Multiple Cables Detected" appears, select the first entry ("Location 0000") and click "OK".

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond03.png}
  \caption{Step 3: Select cable}
  \label{fig:diamond03}
\end{figure}

You have now created a new project which should display "MachXO2" under "Device Family" and "LCMXO2-1200HC" under "Device"

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond04.png}
  \caption{Step 4: New Diamond Programmer project}
  \label{fig:diamond04}
\end{figure}

Choose "File"  then "Open File" to load the DIAMOND PROGRAMMER project with the MEGA65 keyboard firmware update.

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond05.png}
  \caption{Step 5: Open project}
  \label{fig:diamond05}
\end{figure}

Navigate into the folder with the extracted MEGA65 keyboard firmware files you have received and select the file ending with ".xcf".

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond06.png}
  \caption{Step 6: Select project file}
  \label{fig:diamond06}
\end{figure}

Click the three dots under "File Name" to set the correct path and find the file ending with ".jed".

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond07.png}
  \caption{Step 7: Choose correct path of .jed file}
  \label{fig:diamond07}
\end{figure}

Select the file ending with ".jed" and click "OK".

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond08.png}
  \caption{Step 8: Select .jed file}
  \label{fig:diamond08}
\end{figure}

Click on the icon with the green arrow facing down "PROGRAM", which looks similar to the DIAMOND PROGRAMMER program icon.

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond09.png}
  \caption{Step 9: Select cable}
  \label{fig:diamond09}
\end{figure}

After a moment  the Output window should display "INFO - Operation: successful." and the "Status" cell should go green (does not always happen).

\begin{figure}
  \includegraphics[width=\linewidth]{images/diamond10.png}
  \caption{Step 10: Select cable}
  \label{fig:diamond10}
\end{figure}

You have now successfully flashed the MEGA65 keyboard. If you wish you can save the project now for later use.

\section{Flashing the MAX10 FPGA on the MEGA65's Mainboard with INTEL QUARTUS}
